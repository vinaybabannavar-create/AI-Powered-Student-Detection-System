<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Monitor - Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .video-box {
      width: 100%;
      margin: 20px auto;
      border: 4px solid #444;
      border-radius: 15px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
      aspect-ratio: 4 / 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-box img,
    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      z-index: 2;
      /* Ensure video is above processing text */
    }

    .video-box canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
    }

    /* Processing indicator */
    #processingIndicator {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #0f0;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      z-index: 10;
      animation: blink 1s infinite;
    }

    /* Loading / No Signal Message */
    .no-signal {
      position: absolute;
      color: #666;
      text-align: center;
      z-index: 1;
      /* Behind video */
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
    }

    @keyframes blink {
      50% {
        opacity: 0.5;
      }
    }

    /* Metadata overlay for capture */
    #captureMetadata {
      display: none;
      padding: 15px;
      background: #f4f4f4;
      border: 1px solid #ccc;
      margin-top: 10px;
      color: #333;
      font-size: 0.8rem;
      text-align: left;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg">

  <div class="nav">
    <div class="brand">Classroom AI Monitor</div>
    <div class="user">
      Logged in as {{ user }} |
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="card" style="text-align: center; max-width: 900px; width: 95%;">

      <h2>Classroom Live Dashboard</h2>
      <p>Monitor student attendance and activity in real-time.</p>

      {% if show_video %}
      <div class="video-box">
        <!-- Loading / No Signal Message -->
        <div class="no-signal">
          <div style="font-size: 2rem; margin-bottom: 10px;">üì∑</div>
          <div>Waiting for camera feed...</div>
          <div style="font-size: 0.8rem; margin-top: 5px;">(Ensure camera permissions are granted)</div>
        </div>

        <!-- Local Webcam Feed for Laptop -->
        <img id="localFeed" src="{{ url_for('video_feed') }}" alt="Live Feed" style="display: none;">
        <!-- Mobile Camera: video shown live, canvas overlays processed frames on top -->
        <video id="video" width="640" height="480" autoplay playsinline muted style="display: none;"></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        <div id="processingIndicator">‚öô Processing...</div>
      </div>

      <div class="status active">
        <span class="dot pulse"></span> Monitor ACTIVE
      </div>

      <div class="count-display">
        <div style="font-size: 0.9rem; color: #666; font-weight: 500;">TOTAL STUDENTS DETECTED</div>
        <span id="studentCount">0</span>
      </div>

      <div id="captureMetadata">
        <strong>Session Metadata:</strong><br>
        Date: <span id="metaDate"></span><br>
        Time: <span id="metaTime"></span><br>
        Location: <span id="metaLoc">Fetching...</span>
      </div>

      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button id="captureBtn" class="btn" style="background: #2ecc71; border-color: #27ae60;">
          üì∏ Capture Attendance Proof
        </button>
      </div>
      {% else %}
      <div class="status">
        Status: Ready to Start
      </div>
      {% endif %}

      <div style="margin-top: 20px;">
        <a id="sessionBtn" class="btn {% if show_video %}btn-danger{% endif %}" href="{{ url_for('start_session') }}"
          style="display: block; max-width: 100%; box-sizing: border-box;">
          {% if show_video %}Stop Session{% else %}Start Classroom Session{% endif %}
        </a>
      </div>
      <style>
        .btn-danger {
          background: linear-gradient(90deg, #dc2626, #ef4444) !important;
          box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4) !important;
        }

        .btn-danger:hover {
          background: linear-gradient(90deg, #b91c1c, #dc2626) !important;
          box-shadow: 0 6px 20px rgba(185, 28, 28, 0.5) !important;
        }
      </style>



    </div>
  </div>

  <script>
    {% if show_video %}
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const studentCountDisplay = document.getElementById('studentCount');
    const localFeed = document.getElementById('localFeed');
    const processingIndicator = document.getElementById('processingIndicator');

    // Track whether a request is in-flight to prevent pile-up
    let isProcessing = false;
    let sessionActive = true;

    // Check if device is mobile or if we are hosted on a remote server (like Render)
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    let isHosted = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';

    if (isMobile || isHosted) {
      // Use browser camera (environment for mobile, default for desktop)
      // Reverted to simpler constraints for compatibility
      const constraints = isMobile
        ? { video: { facingMode: "environment" } }
        : { video: true };

      navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        video.srcObject = stream;
        video.style.display = 'block';
        processingIndicator.style.display = 'block';

        // Wait for video to be ready, then start sequential processing
        video.onloadedmetadata = () => {
          // Match canvas to actual video dimensions
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          // Start the first capture; each one chains to the next
          captureAndUpload();
        };
      }).catch(err => {
        console.error("Camera error:", err);
        const noSignal = document.querySelector('.no-signal');
        if (noSignal) {
          noSignal.innerHTML = `
             <div style="font-size: 2rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
             <div style="color: #ef4444; font-weight: bold;">Camera Access Denied</div>
             <div style="font-size: 0.8rem; margin-top: 5px;">Check browser settings or use HTTPS</div>
           `;
        }
        alert("Camera access denied. Please grant permissions and ensure you are using HTTPS.");
      });
    } else {
      // Local development on Laptop: Use the server-side webcam MJPEG feed
      canvas.style.display = 'none';
      localFeed.style.display = 'block';
      // Poll server for latest count from the global tracker
      setInterval(fetchCount, 500);
    }

    function captureAndUpload() {
      // Don't send if previous request is still in-flight or session stopped
      if (!sessionActive) return;
      if (!video.videoWidth || !video.videoHeight) {
        // Video not ready yet, retry in 500ms
        setTimeout(captureAndUpload, 500);
        return;
      }

      isProcessing = true;

      // Use a smaller resolution for the upload to reduce payload & processing time
      const UPLOAD_WIDTH = isMobile ? 240 : 320;
      const UPLOAD_HEIGHT = Math.round(UPLOAD_WIDTH * (video.videoHeight / video.videoWidth));

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = UPLOAD_WIDTH;
      tempCanvas.height = UPLOAD_HEIGHT;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0, UPLOAD_WIDTH, UPLOAD_HEIGHT);
      const dataURL = tempCanvas.toDataURL('image/jpeg', 0.4);

      fetch('/process_frame', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            studentCountDisplay.innerText = data.count;
            // Draw the processed frame (with bounding boxes) on the overlay canvas
            if (data.frame) {
              const img = new Image();
              img.onload = function () {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              };
              img.src = data.frame;
            }
          }
          isProcessing = false;
          // Schedule next capture AFTER this one completes (no pile-up)
          // Increased delay for Render performance (700ms)
          if (sessionActive) setTimeout(captureAndUpload, 700);
        })
        .catch(err => {
          console.error("Frame processing error:", err);
          isProcessing = false;
          // Retry after a longer delay on error
          if (sessionActive) setTimeout(captureAndUpload, 2000);
        });
    }

    function fetchCount() {
      fetch('/current_count')
        .then(res => res.json())
        .then(data => {
          studentCountDisplay.innerText = data.count || 0;
        });
    }

    // Capture to PDF Logic
    document.getElementById('captureBtn').addEventListener('click', async function () {
      const btn = this;
      btn.innerText = "‚è≥ Preparing PDF...";
      btn.disabled = true;

      const metaDiv = document.getElementById('captureMetadata');
      const now = new Date();
      document.getElementById('metaDate').innerText = now.toLocaleDateString();
      document.getElementById('metaTime').innerText = now.toLocaleTimeString();

      // Get Location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            document.getElementById('metaLoc').innerText = `${pos.coords.latitude}, ${pos.coords.longitude}`;
            generatePDF();
          },
          (err) => {
            document.getElementById('metaLoc').innerText = "Location access denied";
            generatePDF();
          }
        );
      } else {
        document.getElementById('metaLoc').innerText = "GPS not supported";
        generatePDF();
      }

      async function generatePDF() {
        try {
          let imgData;

          // Check if we're using browser camera (mobile or hosted desktop) or local MJPEG feed
          const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          const isHostedDevice = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';

          if (isMobileDevice || isHostedDevice) {
            // BROWSER CAMERA MODE: Capture a combined frame (live video + overlay)
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = canvas.width;
            captureCanvas.height = canvas.height;
            const captureCtx = captureCanvas.getContext('2d');
            // Draw the live video first
            captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            // Draw the processed overlay (bounding boxes) on top
            captureCtx.drawImage(canvas, 0, 0, captureCanvas.width, captureCanvas.height);
            imgData = captureCanvas.toDataURL('image/jpeg', 0.9);
          } else {
            // LOCAL LAPTOP: Capture from server MJPEG feed
            const localFeedImg = document.getElementById('localFeed');

            // Create a temporary canvas to capture the image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = localFeedImg.naturalWidth || 640;
            tempCanvas.height = localFeedImg.naturalHeight || 480;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw the server feed image to the temporary canvas
            tempCtx.drawImage(localFeedImg, 0, 0, tempCanvas.width, tempCanvas.height);

            imgData = tempCanvas.toDataURL('image/jpeg', 0.9);
          }

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');

          // Page dimensions
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const margin = 15;

          // === OUTER BORDER ===
          pdf.setDrawColor(0, 102, 204); // Blue border
          pdf.setLineWidth(1);
          pdf.rect(5, 5, pageWidth - 10, pageHeight - 10);

          // === INNER BORDER ===
          pdf.setDrawColor(100, 100, 100); // Gray inner border
          pdf.setLineWidth(0.5);
          pdf.rect(10, 10, pageWidth - 20, pageHeight - 20);

          // === HEADER SECTION ===
          pdf.setFillColor(0, 102, 204); // Blue header background
          pdf.rect(margin, margin, pageWidth - 2 * margin, 25, 'F');

          pdf.setTextColor(255, 255, 255); // White text
          pdf.setFontSize(20);
          pdf.setFont(undefined, 'bold');
          pdf.text('CLASSROOM ATTENDANCE REPORT', pageWidth / 2, margin + 10, { align: 'center' });

          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text('AI-Powered Student Detection System', pageWidth / 2, margin + 18, { align: 'center' });

          // === METADATA SECTION ===
          let yPos = margin + 35;
          pdf.setTextColor(0, 0, 0);
          pdf.setFontSize(11);
          pdf.setFont(undefined, 'bold');
          pdf.text('Session Information:', margin + 5, yPos);

          yPos += 8;
          pdf.setFont(undefined, 'normal');
          pdf.setFontSize(10);

          const metaDate = now.toLocaleDateString();
          const metaTime = now.toLocaleTimeString();
          const studentCount = document.getElementById('studentCount').innerText;

          pdf.text(`Date: ${metaDate}`, margin + 5, yPos);
          yPos += 6;
          pdf.text(`Time: ${metaTime}`, margin + 5, yPos);
          yPos += 6;
          pdf.text(`Total Students Detected: ${studentCount}`, margin + 5, yPos);
          yPos += 6;
          pdf.text(`Logged by: {{ user }}`, margin + 5, yPos);

          // Get Location
          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
              });
              yPos += 6;
              pdf.text(`Location: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`, margin + 5, yPos);
            } catch (err) {
              yPos += 6;
              pdf.text(`Location: Not available`, margin + 5, yPos);
            }
          } else {
            yPos += 6;
            pdf.text(`Location: GPS not supported`, margin + 5, yPos);
          }

          // === SEPARATOR LINE ===
          yPos += 5;
          pdf.setDrawColor(200, 200, 200);
          pdf.setLineWidth(0.5);
          pdf.line(margin + 5, yPos, pageWidth - margin - 5, yPos);

          // === SNAPSHOT SECTION ===
          yPos += 10;
          pdf.setFontSize(11);
          pdf.setFont(undefined, 'bold');
          pdf.text('Live Classroom Snapshot:', margin + 5, yPos);

          yPos += 5;

          // Calculate dimensions to fit nicely
          const imgProps = pdf.getImageProperties(imgData);
          const imgWidth = pageWidth - 2 * margin - 10;
          const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

          // Add border around image
          pdf.setDrawColor(150, 150, 150);
          pdf.setLineWidth(1);
          pdf.rect(margin + 5, yPos, imgWidth, imgHeight);

          pdf.addImage(imgData, 'JPEG', margin + 5, yPos, imgWidth, imgHeight);

          yPos += imgHeight + 10;

          // === STUDENT COUNT DISPLAY BOX ===
          pdf.setFillColor(0, 102, 204); // Blue background
          const boxHeight = 25;
          pdf.rect(margin + 5, yPos, imgWidth, boxHeight, 'F');

          // Add border to box
          pdf.setDrawColor(0, 80, 160);
          pdf.setLineWidth(1);
          pdf.rect(margin + 5, yPos, imgWidth, boxHeight);

          // Student count text
          pdf.setTextColor(255, 255, 255);
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          const countText = `TOTAL STUDENTS DETECTED: ${studentCount}`;
          pdf.text(countText, pageWidth / 2, yPos + 16, { align: 'center' });

          // === FOOTER SECTION ===
          const footerY = pageHeight - 15;
          pdf.setFillColor(240, 240, 240);
          pdf.rect(margin, footerY - 5, pageWidth - 2 * margin, 10, 'F');

          pdf.setTextColor(100, 100, 100);
          pdf.setFontSize(8);
          pdf.setFont(undefined, 'italic');
          pdf.text('Generated by AI Classroom Monitor System', margin + 5, footerY);
          pdf.text(`Page 1 | ${new Date().toLocaleString()}`, pageWidth - margin - 5, footerY, { align: 'right' });

          // === SAVE PDF ===
          const fileName = `Attendance_Report_${now.toISOString().replace(/[:.]/g, '-')}.pdf`;
          pdf.save(fileName);
        } catch (error) {
          console.error("PDF Error:", error);
          alert("Failed to generate PDF. Please try again.");
        } finally {
          btn.innerText = "üì∏ Capture Attendance Proof";
          btn.disabled = false;
        }
      }
    });

    // Toggle session stop - also stops camera processing
    document.getElementById('sessionBtn').addEventListener('click', function (e) {
      if (this.innerText.includes("Stop")) {
        e.preventDefault();
        sessionActive = false;
        // Stop camera tracks to release the camera
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        window.location.href = "{{ url_for('dashboard') }}";
      }
    });
    {% endif %}
  </script>
</body>

</html>